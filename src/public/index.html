<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Issues - Devin Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50" x-data="dashboardApp()">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-robot text-blue-600 text-2xl"></i>
                    <h1 class="text-2xl font-bold text-gray-900">GitHub Issues - Devin Integration</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button @click="refreshIssues()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                    <select x-model="filters.state" @change="refreshIssues()" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <option value="open">Open</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                    <select x-model="filters.sort" @change="refreshIssues()" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <option value="created">Created</option>
                        <option value="updated">Updated</option>
                        <option value="comments">Comments</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Labels (comma-separated)</label>
                    <input type="text" x-model="filters.labels" @keyup.enter="refreshIssues()" placeholder="bug, enhancement" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>
            </div>
        </div>

        <!-- Issues List -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b">
                <h2 class="text-lg font-semibold">Issues</h2>
                <p class="text-sm text-gray-600" x-show="issues.length > 0">
                    Showing <span x-text="issues.length"></span> issues
                </p>
            </div>

            <div x-show="loading" class="p-8 text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
                <p class="mt-2 text-gray-600">Loading issues...</p>
            </div>

            <div x-show="!loading && issues.length === 0" class="p-8 text-center">
                <i class="fas fa-inbox text-4xl text-gray-400"></i>
                <p class="mt-2 text-gray-600">No issues found</p>
            </div>

            <div x-show="!loading && issues.length > 0" class="divide-y">
                <template x-for="issue in issues" :key="issue.id">
                    <div class="p-6 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="issue.state === 'open' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                        <i class="fas fa-circle mr-1 text-[8px]" :class="issue.state === 'open' ? 'text-green-600' : 'text-red-600'"></i>
                                        <span x-text="issue.state"></span>
                                    </span>
                                    <span class="text-sm font-medium text-gray-900">
                                        #<span x-text="issue.number"></span>
                                    </span>
                                    <template x-for="label in issue.labels" :key="label">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800" x-text="label"></span>
                                    </template>
                                </div>

                                <h3 class="text-lg font-medium text-gray-900 mb-2" x-text="issue.title"></h3>

                                <div class="flex items-center space-x-4 text-sm text-gray-600">
                                    <span>
                                        <i class="fas fa-user mr-1"></i>
                                        <span x-text="issue.user"></span>
                                    </span>
                                    <span>
                                        <i class="fas fa-calendar mr-1"></i>
                                        <span x-text="new Date(issue.created_at).toLocaleDateString()"></span>
                                    </span>
                                    <span x-show="issue.assignees.length > 0">
                                        <i class="fas fa-user-check mr-1"></i>
                                        <span x-text="issue.assignees.join(', ')"></span>
                                    </span>
                                </div>

                                <!-- Action Buttons -->
                                <div class="mt-4 flex flex-wrap gap-2">
                                    <button @click="analyzeIssue(issue)"
                                            :disabled="analyzingIssue === issue.number"
                                            class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition disabled:opacity-50">
                                        <template x-if="analyzingIssue !== issue.number">
                                            <span><i class="fas fa-search mr-1"></i>Analyze</span>
                                        </template>
                                        <template x-if="analyzingIssue === issue.number">
                                            <span><i class="fas fa-spinner fa-spin mr-1"></i>Analyzing...</span>
                                        </template>
                                    </button>

                                    <button @click="generatePlan(issue)"
                                            :disabled="planningIssue === issue.number"
                                            class="px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition disabled:opacity-50">
                                        <template x-if="planningIssue !== issue.number">
                                            <span><i class="fas fa-tasks mr-1"></i>Plan</span>
                                        </template>
                                        <template x-if="planningIssue === issue.number">
                                            <span><i class="fas fa-spinner fa-spin mr-1"></i>Planning...</span>
                                        </template>
                                    </button>

                                    <button @click="executeIssue(issue)"
                                            :disabled="executingIssue === issue.number || !issue.actionPlan"
                                            class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition disabled:opacity-50">
                                        <template x-if="executingIssue !== issue.number">
                                            <span><i class="fas fa-play mr-1"></i>Execute</span>
                                        </template>
                                        <template x-if="executingIssue === issue.number">
                                            <span><i class="fas fa-spinner fa-spin mr-1"></i>Starting...</span>
                                        </template>
                                    </button>

                                    <a :href="issue.html_url" target="_blank" class="px-3 py-1.5 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 transition">
                                        <i class="fas fa-external-link-alt mr-1"></i>GitHub
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Results -->
                        <div x-show="issue.analysis" x-transition class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-blue-900">Analysis Results</h4>
                                <template x-if="issue.analysis?.session_url">
                                    <a :href="issue.analysis.session_url" target="_blank"
                                       class="text-xs text-blue-600 hover:underline">
                                        View Devin Session <i class="fas fa-external-link-alt ml-1"></i>
                                    </a>
                                </template>
                            </div>
                            <template x-if="issue.analysis?.fallback">
                                <p class="text-xs text-yellow-700 bg-yellow-50 px-2 py-1 rounded mb-2 inline-block">Fallback mode (Devin API unavailable)</p>
                            </template>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm mb-3">
                                <div class="bg-white rounded p-2">
                                    <span class="font-medium text-gray-600 block text-xs">Complexity</span>
                                    <span class="text-lg font-bold" x-text="(issue.analysis?.complexity || 0) + '/10'"></span>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <span class="font-medium text-gray-600 block text-xs">Confidence</span>
                                    <span class="text-lg font-bold" x-text="(issue.analysis?.confidence_score || 0) + '%'"></span>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <span class="font-medium text-gray-600 block text-xs">Est. Time</span>
                                    <span class="text-lg font-bold" x-text="issue.analysis?.estimated_time || '-'"></span>
                                </div>
                            </div>
                            <div class="text-sm">
                                <span class="font-medium text-gray-700">Scope:</span>
                                <p class="text-gray-600 mt-1" x-text="issue.analysis?.scope"></p>
                            </div>
                            <div class="mt-2 text-sm" x-show="issue.analysis?.requirements?.length > 0">
                                <span class="font-medium text-gray-700">Requirements:</span>
                                <ul class="mt-1 list-disc list-inside text-gray-600">
                                    <template x-for="req in (issue.analysis?.requirements || [])" :key="req">
                                        <li x-text="req"></li>
                                    </template>
                                </ul>
                            </div>
                            <div class="mt-2 text-sm" x-show="issue.analysis?.risks?.length > 0">
                                <span class="font-medium text-gray-700">Risks:</span>
                                <ul class="mt-1 list-disc list-inside text-gray-600">
                                    <template x-for="risk in (issue.analysis?.risks || [])" :key="risk">
                                        <li x-text="risk"></li>
                                    </template>
                                </ul>
                            </div>
                        </div>

                        <!-- Action Plan -->
                        <div x-show="issue.actionPlan" x-transition class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-green-900">Action Plan</h4>
                                <template x-if="issue.actionPlan?.session_url">
                                    <a :href="issue.actionPlan.session_url" target="_blank"
                                       class="text-xs text-green-600 hover:underline">
                                        View Devin Session <i class="fas fa-external-link-alt ml-1"></i>
                                    </a>
                                </template>
                            </div>
                            <template x-if="issue.actionPlan?.fallback">
                                <p class="text-xs text-yellow-700 bg-yellow-50 px-2 py-1 rounded mb-2 inline-block">Fallback mode (Devin API unavailable)</p>
                            </template>
                            <div class="text-sm">
                                <span class="font-medium text-gray-700">Steps:</span>
                                <ol class="mt-1 list-decimal list-inside text-gray-600 space-y-1">
                                    <template x-for="step in (issue.actionPlan?.steps || [])" :key="step">
                                        <li x-text="step"></li>
                                    </template>
                                </ol>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 text-sm">
                                <div x-show="issue.actionPlan?.files_to_create?.length > 0">
                                    <span class="font-medium text-gray-700">Files to Create:</span>
                                    <ul class="mt-1 text-gray-600">
                                        <template x-for="f in (issue.actionPlan?.files_to_create || [])" :key="f">
                                            <li class="font-mono text-xs">+ <span x-text="f"></span></li>
                                        </template>
                                    </ul>
                                </div>
                                <div x-show="issue.actionPlan?.files_to_modify?.length > 0">
                                    <span class="font-medium text-gray-700">Files to Modify:</span>
                                    <ul class="mt-1 text-gray-600">
                                        <template x-for="f in (issue.actionPlan?.files_to_modify || [])" :key="f">
                                            <li class="font-mono text-xs">~ <span x-text="f"></span></li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-2 text-sm" x-show="issue.actionPlan?.testing_strategy">
                                <span class="font-medium text-gray-700">Testing:</span>
                                <span class="text-gray-600" x-text="issue.actionPlan?.testing_strategy"></span>
                            </div>
                        </div>

                        <!-- Execution Result -->
                        <div x-show="issue.execution" x-transition class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-purple-900">Execution Started</h4>
                                <template x-if="issue.execution?.session_url">
                                    <a :href="issue.execution.session_url" target="_blank"
                                       class="text-sm text-purple-600 hover:underline font-medium">
                                        Track in Devin <i class="fas fa-external-link-alt ml-1"></i>
                                    </a>
                                </template>
                            </div>
                            <div class="text-sm text-gray-600">
                                <p>Session ID: <span class="font-mono" x-text="issue.execution?.session_id"></span></p>
                                <p>Status: <span class="font-medium" x-text="issue.execution?.status"></span></p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div x-show="notification.show"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed bottom-4 right-4 max-w-sm bg-white rounded-lg shadow-lg p-4 z-50 border">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas" :class="notification.type === 'success' ? 'fa-check-circle text-green-500' : notification.type === 'info' ? 'fa-info-circle text-blue-500' : 'fa-exclamation-circle text-red-500'"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-gray-900" x-text="notification.title"></p>
                <p class="text-sm text-gray-500" x-text="notification.message"></p>
            </div>
            <button @click="notification.show = false" class="ml-auto flex-shrink-0">
                <i class="fas fa-times text-gray-400 hover:text-gray-600"></i>
            </button>
        </div>
    </div>

    <script>
        function dashboardApp() {
            return {
                issues: [],
                loading: false,
                analyzingIssue: null,
                planningIssue: null,
                executingIssue: null,
                filters: {
                    state: 'open',
                    sort: 'created',
                    labels: ''
                },
                notification: {
                    show: false,
                    type: 'success',
                    title: '',
                    message: ''
                },

                init() {
                    this.refreshIssues();
                },

                async refreshIssues() {
                    this.loading = true;
                    try {
                        const params = new URLSearchParams({
                            state: this.filters.state,
                            sort: this.filters.sort
                        });

                        if (this.filters.labels.trim()) {
                            params.append('labels', this.filters.labels.trim());
                        }

                        const response = await fetch(`/api/issues?${params}`);
                        if (!response.ok) throw new Error('Failed to fetch issues');

                        this.issues = await response.json();
                    } catch (error) {
                        this.showNotification('error', 'Error', error.message);
                    } finally {
                        this.loading = false;
                    }
                },

                async analyzeIssue(issue) {
                    this.analyzingIssue = issue.number;
                    this.showNotification('info', 'Analyzing', `Creating Devin session for issue #${issue.number}... This may take a few minutes.`);
                    try {
                        const response = await fetch(`/api/issues/${issue.number}/analyze`, {
                            method: 'POST'
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error || 'Failed to analyze issue');
                        }

                        const analysis = await response.json();
                        issue.analysis = analysis;

                        const mode = analysis.fallback ? ' (fallback)' : '';
                        this.showNotification('success', 'Analysis Complete' + mode, `Issue #${issue.number}: complexity ${analysis.complexity}/10, confidence ${analysis.confidence_score}%`);
                    } catch (error) {
                        this.showNotification('error', 'Analysis Failed', error.message);
                    } finally {
                        this.analyzingIssue = null;
                    }
                },

                async generatePlan(issue) {
                    this.planningIssue = issue.number;
                    this.showNotification('info', 'Planning', `Generating action plan for issue #${issue.number}...`);
                    try {
                        const response = await fetch(`/api/issues/${issue.number}/plan`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ analysis: issue.analysis })
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error || 'Failed to generate action plan');
                        }

                        const actionPlan = await response.json();
                        issue.actionPlan = actionPlan;

                        const mode = actionPlan.fallback ? ' (fallback)' : '';
                        this.showNotification('success', 'Plan Generated' + mode, `${(actionPlan.steps || []).length} steps for issue #${issue.number}`);
                    } catch (error) {
                        this.showNotification('error', 'Plan Failed', error.message);
                    } finally {
                        this.planningIssue = null;
                    }
                },

                async executeIssue(issue) {
                    if (!issue.actionPlan) {
                        this.showNotification('error', 'No Plan', 'Generate an action plan first');
                        return;
                    }

                    if (!confirm(`Start a Devin session to execute the action plan for issue #${issue.number}?`)) {
                        return;
                    }

                    this.executingIssue = issue.number;
                    try {
                        const response = await fetch(`/api/issues/${issue.number}/execute`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ actionPlan: issue.actionPlan })
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error || 'Failed to execute');
                        }

                        const result = await response.json();
                        issue.execution = result;

                        this.showNotification('success', 'Execution Started',
                            `Devin is working on issue #${issue.number}. Track progress in the Devin session.`);
                    } catch (error) {
                        this.showNotification('error', 'Execution Failed', error.message);
                    } finally {
                        this.executingIssue = null;
                    }
                },

                showNotification(type, title, message) {
                    this.notification = { show: true, type, title, message };
                    setTimeout(() => { this.notification.show = false; }, 6000);
                }
            };
        }
    </script>
</body>
</html>
